#!/bin/bash
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

# include library
source $DIR/../lib/utils

# include configurations
source $DIR/../share/config/base
source $DIR/../share/config/gentoo
if [ -f ./config ]; then
    # override using version in local directory
    source ./config
fi

# check that requried files are present and available.
export BOOT_ISO=$GENTOO_BOOT_ISO
export VBOX_NAME=$GENTOO_VM_NAME

checkenv GENTOO_STAGE3 GENTOO_PORTAGE
checkenvfile GENTOO_STAGE3 GENTOO_PORTAGE

create_vm

if [ $? -ne 0 ]; then
    echo "failed to create vm ${VBOX_NAME} for gentoo build"
    exit 1
fi

VBoxManage startvm "${VBOX_NAME}"

# hit enter a couple times
# first to boot from the iso.
sleep 5
runscancode ""
# then to select default keyboard layout.
sleep 10
runscancode ""

echo "sleeping for 20 seconds before working"
sleep 20

# get the guest to talk to the host to populate the arp table
runscancode "ping -c1 $VBOX_HOST_IP"

set_vm_mac_ip $VBOX_NAME $VBOX_NET
if [ $? -ne 0 ]; then
    echo "failed to derive IP, cannot continue with automated installation"
    exit 1
fi

# run everything in a screen session
runscancode "/etc/init.d/sshd start"
runscancode "mkdir ~/.ssh"
runscancode "echo $(cat $VBOX_PUBKEY) > ~/.ssh/authorized_keys"

scp -oStrictHostKeyChecking=no -oBatchMode=Yes -i $VBOX_PRIVKEY \
    $GENTOO_STAGE3 root@$VBOX_IP:stage3-amd64.tar

scp -oStrictHostKeyChecking=no -oBatchMode=Yes -i $VBOX_PRIVKEY \
    $GENTOO_PORTAGE root@$VBOX_IP:portage.tar

rsync -re "ssh -oStrictHostKeyChecking=no -oBatchMode=Yes -i $VBOX_PRIVKEY" \
    $GENTOO_FILES/ root@$VBOX_IP:gentoo_files

# pass that as a stuff directly into the screen session
ssh -oStrictHostKeyChecking=no -oBatchMode=Yes -i $VBOX_PRIVKEY root@$VBOX_IP \
    ./gentoo_files/init.sh

wait_vm_shutdown "${VBOX_NAME}" 15

if [ $? -ne 0 ]; then
    echo "\"${VBOX_NAME}\" did not shutdown; cannot continue with verification"
    exit 1
fi

# remove the boot iso for proper bootup.
VBoxManage storageattach $VBOX_NAME --storagectl IDE --port 0 --device 0 \
    --medium emptydrive

VBoxManage startvm "${VBOX_NAME}"
echo "the vm may be accessible after it completes the booting process using:"
echo "ssh -oStrictHostKeyChecking=no -oBatchMode=Yes -i $VBOX_PRIVKEY \
    root@$VBOX_IP"
